\hypertarget{internal_8h_source}{}\section{internal.\+h}
\label{internal_8h_source}\index{Vienna\+R\+N\+A/loops/internal.\+h@{Vienna\+R\+N\+A/loops/internal.\+h}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#ifndef VIENNA\_RNA\_PACKAGE\_LOOPS\_INTERNAL\_H}
00002 \textcolor{preprocessor}{#define VIENNA\_RNA\_PACKAGE\_LOOPS\_INTERNAL\_H}
00003 
00004 \textcolor{preprocessor}{#include <\hyperlink{utils_2basic_8h}{ViennaRNA/utils/basic.h}>}
00005 \textcolor{preprocessor}{#include <ViennaRNA/params/default.h>}
00006 \textcolor{preprocessor}{#include <\hyperlink{datastructures_2basic_8h}{ViennaRNA/datastructures/basic.h}>}
00007 \textcolor{preprocessor}{#include <\hyperlink{params_2basic_8h}{ViennaRNA/params/basic.h}>}
00008 \textcolor{preprocessor}{#include <\hyperlink{hard_8h}{ViennaRNA/constraints/hard.h}>}
00009 \textcolor{preprocessor}{#include <\hyperlink{soft_8h}{ViennaRNA/constraints/soft.h}>}
00010 
00011 \textcolor{preprocessor}{#ifdef VRNA\_WARN\_DEPRECATED}
00012 \textcolor{preprocessor}{# if defined(DEPRECATED)}
00013 \textcolor{preprocessor}{#   undef DEPRECATED}
00014 \textcolor{preprocessor}{# endif}
00015 \textcolor{preprocessor}{# if defined(\_\_clang\_\_)}
00016 \textcolor{preprocessor}{#  define DEPRECATED(func, msg) func \_\_attribute\_\_ ((deprecated("", msg)))}
00017 \textcolor{preprocessor}{# elif defined(\_\_GNUC\_\_)}
00018 \textcolor{preprocessor}{#  define DEPRECATED(func, msg) func \_\_attribute\_\_ ((deprecated(msg)))}
00019 \textcolor{preprocessor}{# else}
00020 \textcolor{preprocessor}{#  define DEPRECATED(func, msg) func}
00021 \textcolor{preprocessor}{# endif}
00022 \textcolor{preprocessor}{#else}
00023 \textcolor{preprocessor}{# define DEPRECATED(func, msg) func}
00024 \textcolor{preprocessor}{#endif}
00025 
00026 \textcolor{preprocessor}{#ifdef \_\_GNUC\_\_}
00027 \textcolor{preprocessor}{# define INLINE inline}
00028 \textcolor{preprocessor}{#else}
00029 \textcolor{preprocessor}{# define INLINE}
00030 \textcolor{preprocessor}{#endif}
00031 
00049 \textcolor{keywordtype}{int}
00050 vrna\_E\_int\_loop(\hyperlink{group__fold__compound_structvrna__fc__s}{vrna\_fold\_compound\_t}  *fc,
00051                 \textcolor{keywordtype}{int}                   i,
00052                 \textcolor{keywordtype}{int}                   j);
00053 
00054 
00062 \textcolor{keywordtype}{int}
00063 \hyperlink{group__eval__loops__int_gaab3547bfcdc39d89babbc7ed2a1a4b65}{vrna\_eval\_int\_loop}(\hyperlink{group__fold__compound_structvrna__fc__s}{vrna\_fold\_compound\_t} *fc,
00064                    \textcolor{keywordtype}{int}                  i,
00065                    \textcolor{keywordtype}{int}                  j,
00066                    \textcolor{keywordtype}{int}                  k,
00067                    \textcolor{keywordtype}{int}                  l);
00068 
00069 
00070 \textcolor{keywordtype}{int}
00071 vrna\_E\_ext\_int\_loop(\hyperlink{group__fold__compound_structvrna__fc__s}{vrna\_fold\_compound\_t}  *fc,
00072                     \textcolor{keywordtype}{int}                   i,
00073                     \textcolor{keywordtype}{int}                   j,
00074                     \textcolor{keywordtype}{int}                   *ip,
00075                     \textcolor{keywordtype}{int}                   *iq);
00076 
00077 
00078 \textcolor{keywordtype}{int}
00079 vrna\_E\_stack(\hyperlink{group__fold__compound_structvrna__fc__s}{vrna\_fold\_compound\_t} *fc,
00080              \textcolor{keywordtype}{int}                  i,
00081              \textcolor{keywordtype}{int}                  j);
00082 
00083 
00084 \textcolor{comment}{/* End basic interface */}
00094 \textcolor{comment}{/* j < i indicates circular folding, i.e. collect contributions for exterior int loops */}
00095 \hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL}
00096 vrna\_exp\_E\_int\_loop(\hyperlink{group__fold__compound_structvrna__fc__s}{vrna\_fold\_compound\_t}  *fc,
00097                     \textcolor{keywordtype}{int}                   i,
00098                     \textcolor{keywordtype}{int}                   j);
00099 
00100 
00101 \hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL}
00102 vrna\_exp\_E\_interior\_loop(\hyperlink{group__fold__compound_structvrna__fc__s}{vrna\_fold\_compound\_t} *fc,
00103                          \textcolor{keywordtype}{int}                  i,
00104                          \textcolor{keywordtype}{int}                  j,
00105                          \textcolor{keywordtype}{int}                  k,
00106                          \textcolor{keywordtype}{int}                  l);
00107 
00108 
00109 \textcolor{comment}{/* End partition function interface */}
00127 \textcolor{keywordtype}{int}
00128 \hyperlink{group__mfe__backtracking_ga28015cfbd0afc759b94ff58cc241cb13}{vrna\_BT\_stack}(\hyperlink{group__fold__compound_structvrna__fc__s}{vrna\_fold\_compound\_t}  *fc,
00129               \textcolor{keywordtype}{int}                   *i,
00130               \textcolor{keywordtype}{int}                   *j,
00131               \textcolor{keywordtype}{int}                   *en,
00132               \hyperlink{group__data__structures_structvrna__bp__stack__s}{vrna\_bp\_stack\_t}       *bp\_stack,
00133               \textcolor{keywordtype}{int}                   *stack\_count);
00134 
00135 
00140 \textcolor{keywordtype}{int}
00141 \hyperlink{group__mfe__backtracking_ga90b5a5723173996fb40640ce7c95c07e}{vrna\_BT\_int\_loop}(\hyperlink{group__fold__compound_structvrna__fc__s}{vrna\_fold\_compound\_t} *fc,
00142                  \textcolor{keywordtype}{int}                  *i,
00143                  \textcolor{keywordtype}{int}                  *j,
00144                  \textcolor{keywordtype}{int}                  en,
00145                  \hyperlink{group__data__structures_structvrna__bp__stack__s}{vrna\_bp\_stack\_t}      *bp\_stack,
00146                  \textcolor{keywordtype}{int}                  *stack\_count);
00147 
00148 
00154 \textcolor{preprocessor}{#ifndef VRNA\_DISABLE\_BACKWARD\_COMPATIBILITY}
00155 
00161 \textcolor{preprocessor}{#ifdef ON\_SAME\_STRAND}
00162 \textcolor{preprocessor}{#undef ON\_SAME\_STRAND}
00163 \textcolor{preprocessor}{#endif}
00164 
00165 \textcolor{preprocessor}{#define ON\_SAME\_STRAND(I, J, C)  (((I) >= (C)) || ((J) < (C)))}
00166 
00211 PRIVATE INLINE \textcolor{keywordtype}{int} \hyperlink{group__eval__deprecated_gaafbc187b7f78e8e82afb77dd6f3b8fc5}{E\_IntLoop}(\textcolor{keywordtype}{int}          n1,
00212                              \textcolor{keywordtype}{int}          n2,
00213                              \textcolor{keywordtype}{int}          type,
00214                              \textcolor{keywordtype}{int}          type\_2,
00215                              \textcolor{keywordtype}{int}          si1,
00216                              \textcolor{keywordtype}{int}          sj1,
00217                              \textcolor{keywordtype}{int}          sp1,
00218                              \textcolor{keywordtype}{int}          sq1,
00219                              \hyperlink{group__energy__parameters_structvrna__param__s}{vrna\_param\_t} *P);
00220 
00221 
00241 PRIVATE INLINE \hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL} \hyperlink{group__eval__deprecated_ga95de54d8a2a17645a95e0f34e189d9c9}{exp\_E\_IntLoop}(\textcolor{keywordtype}{int}               u1,
00242                                         \textcolor{keywordtype}{int}               u2,
00243                                         \textcolor{keywordtype}{int}               type,
00244                                         \textcolor{keywordtype}{int}               type2,
00245                                         \textcolor{keywordtype}{short}             si1,
00246                                         \textcolor{keywordtype}{short}             sj1,
00247                                         \textcolor{keywordtype}{short}             sp1,
00248                                         \textcolor{keywordtype}{short}             sq1,
00249                                         \hyperlink{group__energy__parameters_structvrna__exp__param__s}{vrna\_exp\_param\_t}  *P);
00250 
00251 
00252 PRIVATE INLINE \textcolor{keywordtype}{int} E\_IntLoop\_Co(\textcolor{keywordtype}{int}           type,
00253                                 \textcolor{keywordtype}{int}           type\_2,
00254                                 \textcolor{keywordtype}{int}           i,
00255                                 \textcolor{keywordtype}{int}           j,
00256                                 \textcolor{keywordtype}{int}           p,
00257                                 \textcolor{keywordtype}{int}           q,
00258                                 \textcolor{keywordtype}{int}           cutpoint,
00259                                 \textcolor{keywordtype}{short}         si1,
00260                                 \textcolor{keywordtype}{short}         sj1,
00261                                 \textcolor{keywordtype}{short}         sp1,
00262                                 \textcolor{keywordtype}{short}         sq1,
00263                                 \textcolor{keywordtype}{int}           \hyperlink{group__model__details_ga72b511ed1201f7e23ec437e468790d74}{dangles},
00264                                 \hyperlink{group__energy__parameters_structvrna__param__s}{vrna\_param\_t}  *P);
00265 
00266 
00267 \textcolor{comment}{/*}
00268 \textcolor{comment}{ *  ugly but fast interior loop evaluation}
00269 \textcolor{comment}{ *}
00270 \textcolor{comment}{ *  Avoid including this function in your own code. It only serves}
00271 \textcolor{comment}{ *  as a fast inline block internally re-used throughout the RNAlib. It}
00272 \textcolor{comment}{ *  evalutes the free energy of interior loops in single sequences or sequence}
00273 \textcolor{comment}{ *  hybrids. Soft constraints are also applied if available.}
00274 \textcolor{comment}{ *}
00275 \textcolor{comment}{ *  NOTE: do not include into doxygen reference manual!}
00276 \textcolor{comment}{ */}
00277 PRIVATE INLINE \textcolor{keywordtype}{int}
00278 ubf\_eval\_int\_loop(\textcolor{keywordtype}{int}           i,
00279                   \textcolor{keywordtype}{int}           j,
00280                   \textcolor{keywordtype}{int}           p,
00281                   \textcolor{keywordtype}{int}           q,
00282                   \textcolor{keywordtype}{int}           i1,
00283                   \textcolor{keywordtype}{int}           j1,
00284                   \textcolor{keywordtype}{int}           p1,
00285                   \textcolor{keywordtype}{int}           q1,
00286                   \textcolor{keywordtype}{short}         si,
00287                   \textcolor{keywordtype}{short}         sj,
00288                   \textcolor{keywordtype}{short}         sp,
00289                   \textcolor{keywordtype}{short}         sq,
00290                   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} type,
00291                   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} type\_2,
00292                   \textcolor{keywordtype}{int}           *rtype,
00293                   \textcolor{keywordtype}{int}           ij,
00294                   \textcolor{keywordtype}{int}           cp,
00295                   \hyperlink{group__energy__parameters_structvrna__param__s}{vrna\_param\_t}  *P,
00296                   \hyperlink{group__soft__constraints_structvrna__sc__s}{vrna\_sc\_t}     *sc)
00297 \{
00298   \textcolor{keywordtype}{int} energy, u1, u2;
00299 
00300   u1  = p1 - i;
00301   u2  = j1 - q;
00302 
00303   \textcolor{keywordflow}{if} ((cp < 0) || (ON\_SAME\_STRAND(i, p, cp) && ON\_SAME\_STRAND(q, j, cp))) \{
00304     \textcolor{comment}{/* regular interior loop */}
00305     energy = \hyperlink{group__eval__deprecated_gaafbc187b7f78e8e82afb77dd6f3b8fc5}{E\_IntLoop}(u1, u2, type, type\_2, si, sj, sp, sq, P);
00306   \} \textcolor{keywordflow}{else} \{
00307     \textcolor{comment}{/* interior loop like cofold structure */}
00308     \textcolor{keywordtype}{short} Si, Sj;
00309     Si      = ON\_SAME\_STRAND(i, i1, cp) ? si : -1;
00310     Sj      = ON\_SAME\_STRAND(j1, j, cp) ? sj : -1;
00311     energy  = E\_IntLoop\_Co(rtype[type], rtype[type\_2],
00312                            i, j, p, q,
00313                            cp,
00314                            Si, Sj,
00315                            sp, sq,
00316                            P->\hyperlink{group__energy__parameters_a7b84353eb9075c595bad4ceb871bcae7}{model\_details}.\hyperlink{group__model__details_adcda4ff2ea77748ae0e8700288282efc}{dangles},
00317                            P);
00318   \}
00319 
00320   \textcolor{comment}{/* add soft constraints */}
00321   \textcolor{keywordflow}{if} (sc) \{
00322     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_a57e4dbb924ab11f304e3762a3a9b07a1}{energy\_up})
00323       energy += sc->\hyperlink{group__soft__constraints_a57e4dbb924ab11f304e3762a3a9b07a1}{energy\_up}[i1][u1]
00324                 + sc->\hyperlink{group__soft__constraints_a57e4dbb924ab11f304e3762a3a9b07a1}{energy\_up}[q1][u2];
00325 
00326     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_ad139b8e06632e00cbcf3909815d0d03d}{energy\_bp})
00327       energy += sc->\hyperlink{group__soft__constraints_ad139b8e06632e00cbcf3909815d0d03d}{energy\_bp}[ij];
00328 
00329     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack})
00330       \textcolor{keywordflow}{if} (u1 + u2 == 0) \{
00331         \textcolor{keywordtype}{int} a = sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[i]
00332                 + sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[p]
00333                 + sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[q]
00334                 + sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[j];
00335         energy += a;
00336       \}
00337 
00338     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_a32dc86090237888c75491bbd4861a04b}{f})
00339       energy += sc->\hyperlink{group__soft__constraints_a32dc86090237888c75491bbd4861a04b}{f}(i, j, p, q, \hyperlink{group__constraints_gaeab04f34d7730cff2d651d782f95d857}{VRNA\_DECOMP\_PAIR\_IL}, sc->
      \hyperlink{group__soft__constraints_a7574680143df97b9029146c2150bf06d}{data});
00340   \}
00341 
00342   \textcolor{keywordflow}{return} energy;
00343 \}
00344 
00345 
00346 PRIVATE INLINE \textcolor{keywordtype}{int}
00347 ubf\_eval\_int\_loop2(\textcolor{keywordtype}{int}            i,
00348                    \textcolor{keywordtype}{int}            j,
00349                    \textcolor{keywordtype}{int}            p,
00350                    \textcolor{keywordtype}{int}            q,
00351                    \textcolor{keywordtype}{int}            i1,
00352                    \textcolor{keywordtype}{int}            j1,
00353                    \textcolor{keywordtype}{int}            p1,
00354                    \textcolor{keywordtype}{int}            q1,
00355                    \textcolor{keywordtype}{short}          si,
00356                    \textcolor{keywordtype}{short}          sj,
00357                    \textcolor{keywordtype}{short}          sp,
00358                    \textcolor{keywordtype}{short}          sq,
00359                    \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}  type,
00360                    \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}  type\_2,
00361                    \textcolor{keywordtype}{int}            *rtype,
00362                    \textcolor{keywordtype}{int}            ij,
00363                    \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int}   *sn,
00364                    \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int}   *ss,
00365                    \hyperlink{group__energy__parameters_structvrna__param__s}{vrna\_param\_t}   *P,
00366                    \hyperlink{group__soft__constraints_structvrna__sc__s}{vrna\_sc\_t}      *sc)
00367 \{
00368   \textcolor{keywordtype}{int} energy, u1, u2;
00369 
00370   u1  = p1 - i;
00371   u2  = j1 - q;
00372 
00373   \textcolor{keywordflow}{if} ((sn[i] == sn[p]) && (sn[q] == sn[j])) \{
00374     \textcolor{comment}{/* regular interior loop */}
00375     energy = \hyperlink{group__eval__deprecated_gaafbc187b7f78e8e82afb77dd6f3b8fc5}{E\_IntLoop}(u1, u2, type, type\_2, si, sj, sp, sq, P);
00376   \} \textcolor{keywordflow}{else} \{
00377     \textcolor{comment}{/* interior loop like cofold structure */}
00378     \textcolor{keywordtype}{short} Si, Sj;
00379     Si      = (sn[i1] == sn[i]) ? si : -1;
00380     Sj      = (sn[j] == sn[j1]) ? sj : -1;
00381     energy  = E\_IntLoop\_Co(rtype[type], rtype[type\_2],
00382                            i, j, p, q,
00383                            ss[1],
00384                            Si, Sj,
00385                            sp, sq,
00386                            P->\hyperlink{group__energy__parameters_a7b84353eb9075c595bad4ceb871bcae7}{model\_details}.\hyperlink{group__model__details_adcda4ff2ea77748ae0e8700288282efc}{dangles},
00387                            P);
00388   \}
00389 
00390   \textcolor{comment}{/* add soft constraints */}
00391   \textcolor{keywordflow}{if} (sc) \{
00392     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_a57e4dbb924ab11f304e3762a3a9b07a1}{energy\_up})
00393       energy += sc->\hyperlink{group__soft__constraints_a57e4dbb924ab11f304e3762a3a9b07a1}{energy\_up}[i1][u1]
00394                 + sc->\hyperlink{group__soft__constraints_a57e4dbb924ab11f304e3762a3a9b07a1}{energy\_up}[q1][u2];
00395 
00396     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_ad139b8e06632e00cbcf3909815d0d03d}{energy\_bp})
00397       energy += sc->\hyperlink{group__soft__constraints_ad139b8e06632e00cbcf3909815d0d03d}{energy\_bp}[ij];
00398 
00399     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack})
00400       \textcolor{keywordflow}{if} (u1 + u2 == 0) \{
00401         \textcolor{keywordtype}{int} a = sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[i]
00402                 + sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[p]
00403                 + sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[q]
00404                 + sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[j];
00405         energy += a;
00406       \}
00407 
00408     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_a32dc86090237888c75491bbd4861a04b}{f})
00409       energy += sc->\hyperlink{group__soft__constraints_a32dc86090237888c75491bbd4861a04b}{f}(i, j, p, q, \hyperlink{group__constraints_gaeab04f34d7730cff2d651d782f95d857}{VRNA\_DECOMP\_PAIR\_IL}, sc->
      \hyperlink{group__soft__constraints_a7574680143df97b9029146c2150bf06d}{data});
00410   \}
00411 
00412   \textcolor{keywordflow}{return} energy;
00413 \}
00414 
00415 
00416 \textcolor{comment}{/*}
00417 \textcolor{comment}{ *  ugly but fast exterior interior loop evaluation}
00418 \textcolor{comment}{ *}
00419 \textcolor{comment}{ *  Avoid including this function in your own code. It only serves}
00420 \textcolor{comment}{ *  as a fast inline block internally re-used throughout the RNAlib. It}
00421 \textcolor{comment}{ *  evalutes the free energy of interior loops in single sequences or sequence}
00422 \textcolor{comment}{ *  hybrids. Soft constraints are also applied if available.}
00423 \textcolor{comment}{ *}
00424 \textcolor{comment}{ *  NOTE: do not include into doxygen reference manual!}
00425 \textcolor{comment}{ */}
00426 PRIVATE INLINE \textcolor{keywordtype}{int}
00427 ubf\_eval\_ext\_int\_loop(\textcolor{keywordtype}{int}           i,
00428                       \textcolor{keywordtype}{int}           j,
00429                       \textcolor{keywordtype}{int}           p,
00430                       \textcolor{keywordtype}{int}           q,
00431                       \textcolor{keywordtype}{int}           i1,
00432                       \textcolor{keywordtype}{int}           j1,
00433                       \textcolor{keywordtype}{int}           p1,
00434                       \textcolor{keywordtype}{int}           q1,
00435                       \textcolor{keywordtype}{short}         si,
00436                       \textcolor{keywordtype}{short}         sj,
00437                       \textcolor{keywordtype}{short}         sp,
00438                       \textcolor{keywordtype}{short}         sq,
00439                       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} type,
00440                       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} type\_2,
00441                       \textcolor{keywordtype}{int}           length,
00442                       \hyperlink{group__energy__parameters_structvrna__param__s}{vrna\_param\_t}  *P,
00443                       \hyperlink{group__soft__constraints_structvrna__sc__s}{vrna\_sc\_t}     *sc)
00444 \{
00445   \textcolor{keywordtype}{int} energy, u1, u2, u3;
00446 
00447   u1  = i1;
00448   u2  = p1 - j;
00449   u3  = length - q;
00450 
00451   energy = \hyperlink{group__eval__deprecated_gaafbc187b7f78e8e82afb77dd6f3b8fc5}{E\_IntLoop}(u2, u1 + u3, type, type\_2, si, sj, sp, sq, P);
00452 
00453   \textcolor{comment}{/* add soft constraints */}
00454   \textcolor{keywordflow}{if} (sc) \{
00455     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_a57e4dbb924ab11f304e3762a3a9b07a1}{energy\_up}) \{
00456       energy += sc->\hyperlink{group__soft__constraints_a57e4dbb924ab11f304e3762a3a9b07a1}{energy\_up}[j1][u2]
00457                 + ((u3 > 0) ? sc->\hyperlink{group__soft__constraints_a57e4dbb924ab11f304e3762a3a9b07a1}{energy\_up}[q1][u3] : 0)
00458                 + ((u1 > 0) ? sc->\hyperlink{group__soft__constraints_a57e4dbb924ab11f304e3762a3a9b07a1}{energy\_up}[1][u1] : 0);
00459     \}
00460 
00461     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack})
00462       \textcolor{keywordflow}{if} (u1 + u2 + u3 == 0)
00463         energy += sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[i]
00464                   + sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[p]
00465                   + sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[q]
00466                   + sc->\hyperlink{group__soft__constraints_ac20dded6068e81acd0f1139092f66a22}{energy\_stack}[j];
00467 
00468     \textcolor{keywordflow}{if} (sc->\hyperlink{group__soft__constraints_a32dc86090237888c75491bbd4861a04b}{f})
00469       energy += sc->\hyperlink{group__soft__constraints_a32dc86090237888c75491bbd4861a04b}{f}(i, j, p, q, \hyperlink{group__constraints_gaeab04f34d7730cff2d651d782f95d857}{VRNA\_DECOMP\_PAIR\_IL}, sc->
      \hyperlink{group__soft__constraints_a7574680143df97b9029146c2150bf06d}{data});
00470   \}
00471 
00472   \textcolor{keywordflow}{return} energy;
00473 \}
00474 
00475 
00476 PRIVATE INLINE \textcolor{keywordtype}{int}
\Hypertarget{internal_8h_source_l00477}\hyperlink{group__eval__deprecated_gaafbc187b7f78e8e82afb77dd6f3b8fc5}{00477} \hyperlink{group__eval__deprecated_gaafbc187b7f78e8e82afb77dd6f3b8fc5}{E\_IntLoop}(\textcolor{keywordtype}{int}           n1,
00478           \textcolor{keywordtype}{int}           n2,
00479           \textcolor{keywordtype}{int}           type,
00480           \textcolor{keywordtype}{int}           type\_2,
00481           \textcolor{keywordtype}{int}           si1,
00482           \textcolor{keywordtype}{int}           sj1,
00483           \textcolor{keywordtype}{int}           sp1,
00484           \textcolor{keywordtype}{int}           sq1,
00485           \hyperlink{group__energy__parameters_structvrna__param__s}{vrna\_param\_t}  *P)
00486 \{
00487   \textcolor{comment}{/* compute energy of degree 2 loop (stack bulge or interior) */}
00488   \textcolor{keywordtype}{int} nl, ns, u, energy;
00489 
00490   energy = \hyperlink{constants_8h_a12c2040f25d8e3a7b9e1c2024c618cb6}{INF};
00491 
00492   \textcolor{keywordflow}{if} (n1 > n2) \{
00493     nl  = n1;
00494     ns  = n2;
00495   \} \textcolor{keywordflow}{else} \{
00496     nl  = n2;
00497     ns  = n1;
00498   \}
00499 
00500   \textcolor{keywordflow}{if} (nl == 0)
00501     \textcolor{keywordflow}{return} P->stack[type][type\_2];  \textcolor{comment}{/* stack */}
00502 
00503   \textcolor{keywordflow}{if} (ns == 0) \{
00504     \textcolor{comment}{/* bulge */}
00505     energy = (nl <= \hyperlink{constants_8h_ad1bd6eabac419670ddd3c9ed82145988}{MAXLOOP}) ? P->bulge[nl] :
00506              (P->bulge[30] + (\textcolor{keywordtype}{int})(P->lxc * log(nl / 30.)));
00507     \textcolor{keywordflow}{if} (nl == 1) \{
00508       energy += P->stack[type][type\_2];
00509     \} \textcolor{keywordflow}{else} \{
00510       \textcolor{keywordflow}{if} (type > 2)
00511         energy += P->TerminalAU;
00512 
00513       \textcolor{keywordflow}{if} (type\_2 > 2)
00514         energy += P->TerminalAU;
00515     \}
00516 
00517     \textcolor{keywordflow}{return} energy;
00518   \} \textcolor{keywordflow}{else} \{
00519     \textcolor{comment}{/* interior loop */}
00520     \textcolor{keywordflow}{if} (ns == 1) \{
00521       \textcolor{keywordflow}{if} (nl == 1)                    \textcolor{comment}{/* 1x1 loop */}
00522         \textcolor{keywordflow}{return} P->int11[type][type\_2][si1][sj1];
00523 
00524       \textcolor{keywordflow}{if} (nl == 2) \{
00525         \textcolor{comment}{/* 2x1 loop */}
00526         \textcolor{keywordflow}{if} (n1 == 1)
00527           energy = P->int21[type][type\_2][si1][sq1][sj1];
00528         \textcolor{keywordflow}{else}
00529           energy = P->int21[type\_2][type][sq1][si1][sp1];
00530 
00531         \textcolor{keywordflow}{return} energy;
00532       \} \textcolor{keywordflow}{else} \{
00533         \textcolor{comment}{/* 1xn loop */}
00534         energy =
00535           (nl + 1 <=
00536            \hyperlink{constants_8h_ad1bd6eabac419670ddd3c9ed82145988}{MAXLOOP}) ? (P->internal\_loop[nl + 1]) : (P->internal\_loop[30] +
00537                                                     (int)(P->lxc * log((nl + 1) / 30.)));
00538         energy  += \hyperlink{group__utils_gae0b9cd0ce090bd69b951aa73e8fa4f7d}{MIN2}(MAX\_NINIO, (nl - ns) * P->ninio[2]);
00539         energy  += P->mismatch1nI[type][si1][sj1] + P->mismatch1nI[type\_2][sq1][sp1];
00540         \textcolor{keywordflow}{return} energy;
00541       \}
00542     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ns == 2) \{
00543       \textcolor{keywordflow}{if} (nl == 2) \{
00544         \textcolor{comment}{/* 2x2 loop */}
00545         \textcolor{keywordflow}{return} P->int22[type][type\_2][si1][sp1][sq1][sj1];
00546       \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (nl == 3) \{
00547         \textcolor{comment}{/* 2x3 loop */}
00548         energy  = P->internal\_loop[5] + P->ninio[2];
00549         energy  += P->mismatch23I[type][si1][sj1] + P->mismatch23I[type\_2][sq1][sp1];
00550         \textcolor{keywordflow}{return} energy;
00551       \}
00552     \}
00553 
00554     \{
00555       \textcolor{comment}{/* generic interior loop (no else here!)*/}
00556       u       = nl + ns;
00557       energy  =
00558         (u <=
00559          \hyperlink{constants_8h_ad1bd6eabac419670ddd3c9ed82145988}{MAXLOOP}) ? (P->internal\_loop[u]) : (P->internal\_loop[30] + (int)(P->lxc * log((u) / 30.)));
00560 
00561       energy += \hyperlink{group__utils_gae0b9cd0ce090bd69b951aa73e8fa4f7d}{MIN2}(MAX\_NINIO, (nl - ns) * P->ninio[2]);
00562 
00563       energy += P->mismatchI[type][si1][sj1] + P->mismatchI[type\_2][sq1][sp1];
00564     \}
00565   \}
00566 
00567   \textcolor{keywordflow}{return} energy;
00568 \}
00569 
00570 
00571 PRIVATE INLINE \hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL}
\Hypertarget{internal_8h_source_l00572}\hyperlink{group__eval__deprecated_ga95de54d8a2a17645a95e0f34e189d9c9}{00572} \hyperlink{group__eval__deprecated_ga95de54d8a2a17645a95e0f34e189d9c9}{exp\_E\_IntLoop}(\textcolor{keywordtype}{int}               u1,
00573               \textcolor{keywordtype}{int}               u2,
00574               \textcolor{keywordtype}{int}               type,
00575               \textcolor{keywordtype}{int}               type2,
00576               \textcolor{keywordtype}{short}             si1,
00577               \textcolor{keywordtype}{short}             sj1,
00578               \textcolor{keywordtype}{short}             sp1,
00579               \textcolor{keywordtype}{short}             sq1,
00580               \hyperlink{group__energy__parameters_structvrna__exp__param__s}{vrna\_exp\_param\_t}  *P)
00581 \{
00582   \textcolor{keywordtype}{int}     ul, us, no\_close = 0;
00583   \textcolor{keywordtype}{double}  z           = 0.;
00584   \textcolor{keywordtype}{int}     noGUclosure = P->\hyperlink{group__energy__parameters_ac18055127bccc27c1223f1d2f3b01b53}{model\_details}.\hyperlink{group__model__details_a7e883db1f33f8f3baa5c9b140350c78e}{noGUclosure};
00585 
00586   \textcolor{keywordflow}{if} ((noGUclosure) && ((type2 == 3) || (type2 == 4) || (type == 3) || (type == 4)))
00587     no\_close = 1;
00588 
00589   \textcolor{keywordflow}{if} (u1 > u2) \{
00590     ul  = u1;
00591     us  = u2;
00592   \} \textcolor{keywordflow}{else} \{
00593     ul  = u2;
00594     us  = u1;
00595   \}
00596 
00597   \textcolor{keywordflow}{if} (ul == 0) \{
00598     \textcolor{comment}{/* stack */}
00599     z = P->expstack[type][type2];
00600   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!no\_close) \{
00601     \textcolor{keywordflow}{if} (us == 0) \{
00602       \textcolor{comment}{/* bulge */}
00603       z = P->expbulge[ul];
00604       \textcolor{keywordflow}{if} (ul == 1) \{
00605         z *= P->expstack[type][type2];
00606       \} \textcolor{keywordflow}{else} \{
00607         \textcolor{keywordflow}{if} (type > 2)
00608           z *= P->expTermAU;
00609 
00610         \textcolor{keywordflow}{if} (type2 > 2)
00611           z *= P->expTermAU;
00612       \}
00613 
00614       \textcolor{keywordflow}{return} (\hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL})z;
00615     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (us == 1) \{
00616       \textcolor{keywordflow}{if} (ul == 1)                     \textcolor{comment}{/* 1x1 loop */}
00617         \textcolor{keywordflow}{return} (\hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL})(P->expint11[type][type2][si1][sj1]);
00618 
00619       \textcolor{keywordflow}{if} (ul == 2) \{
00620         \textcolor{comment}{/* 2x1 loop */}
00621         \textcolor{keywordflow}{if} (u1 == 1)
00622           \textcolor{keywordflow}{return} (\hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL})(P->expint21[type][type2][si1][sq1][sj1]);
00623         \textcolor{keywordflow}{else}
00624           \textcolor{keywordflow}{return} (\hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL})(P->expint21[type2][type][sq1][si1][sp1]);
00625       \} \textcolor{keywordflow}{else} \{
00626         \textcolor{comment}{/* 1xn loop */}
00627         z = P->expinternal[ul + us] * P->expmismatch1nI[type][si1][sj1] *
00628             P->expmismatch1nI[type2][sq1][sp1];
00629         \textcolor{keywordflow}{return} (\hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL})(z * P->expninio[2][ul - us]);
00630       \}
00631     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (us == 2) \{
00632       \textcolor{keywordflow}{if} (ul == 2) \{
00633         \textcolor{comment}{/* 2x2 loop */}
00634         \textcolor{keywordflow}{return} (\hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL})(P->expint22[type][type2][si1][sp1][sq1][sj1]);
00635       \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ul == 3) \{
00636         \textcolor{comment}{/* 2x3 loop */}
00637         z = P->expinternal[5] * P->expmismatch23I[type][si1][sj1] *
00638             P->expmismatch23I[type2][sq1][sp1];
00639         \textcolor{keywordflow}{return} (\hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL})(z * P->expninio[2][1]);
00640       \}
00641     \}
00642 
00643     \textcolor{comment}{/* generic interior loop (no else here!)*/}
00644     z = P->expinternal[ul + us] * P->expmismatchI[type][si1][sj1] *
00645         P->expmismatchI[type2][sq1][sp1];
00646     \textcolor{keywordflow}{return} (\hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL})(z * P->expninio[2][ul - us]);
00647   \}
00648 
00649   \textcolor{keywordflow}{return} (\hyperlink{group__data__structures_ga31125aeace516926bf7f251f759b6126}{FLT\_OR\_DBL})z;
00650 \}
00651 
00652 
00653 PRIVATE INLINE \textcolor{keywordtype}{int}
00654 E\_IntLoop\_Co(\textcolor{keywordtype}{int}          type,
00655              \textcolor{keywordtype}{int}          type\_2,
00656              \textcolor{keywordtype}{int}          i,
00657              \textcolor{keywordtype}{int}          j,
00658              \textcolor{keywordtype}{int}          p,
00659              \textcolor{keywordtype}{int}          q,
00660              \textcolor{keywordtype}{int}          cutpoint,
00661              \textcolor{keywordtype}{short}        si1,
00662              \textcolor{keywordtype}{short}        sj1,
00663              \textcolor{keywordtype}{short}        sp1,
00664              \textcolor{keywordtype}{short}        sq1,
00665              \textcolor{keywordtype}{int}          \hyperlink{group__model__details_ga72b511ed1201f7e23ec437e468790d74}{dangles},
00666              \hyperlink{group__energy__parameters_structvrna__param__s}{vrna\_param\_t} *P)
00667 \{
00668   \textcolor{keywordtype}{int} energy, ci, cj, cp, cq, d3, d5, d5\_2, d3\_2, tmm, tmm\_2;
00669 
00670   energy = 0;
00671   \textcolor{keywordflow}{if} (type > 2)
00672     energy += P->TerminalAU;
00673 
00674   \textcolor{keywordflow}{if} (type\_2 > 2)
00675     energy += P->TerminalAU;
00676 
00677   \textcolor{keywordflow}{if} (!dangles)
00678     \textcolor{keywordflow}{return} energy;
00679 
00680   ci  = ON\_SAME\_STRAND(i, i + 1, cutpoint);
00681   cj  = ON\_SAME\_STRAND(j - 1, j, cutpoint);
00682   cp  = ON\_SAME\_STRAND(p - 1, p, cutpoint);
00683   cq  = ON\_SAME\_STRAND(q, q + 1, cutpoint);
00684 
00685   d3    = ci  ? P->dangle3[type][si1]   : 0;
00686   d5    = cj  ? P->dangle5[type][sj1]   : 0;
00687   d5\_2  = cp  ? P->dangle5[type\_2][sp1] : 0;
00688   d3\_2  = cq  ? P->dangle3[type\_2][sq1] : 0;
00689 
00690   tmm   = (cj && ci) ? P->mismatchExt[type][sj1][si1]   : d5 + d3;
00691   tmm\_2 = (cp && cq) ? P->mismatchExt[type\_2][sp1][sq1] : d5\_2 + d3\_2;
00692 
00693   \textcolor{keywordflow}{if} (dangles == 2)
00694     \textcolor{keywordflow}{return} energy + tmm + tmm\_2;
00695 
00696   \textcolor{comment}{/* now we may have non-double dangles only */}
00697   \textcolor{keywordflow}{if} (p - i > 2) \{
00698     \textcolor{keywordflow}{if} (j - q > 2)
00699       energy += tmm + tmm\_2;
00700     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (j - q == 2)
00701       energy += (cj && cq) ? \hyperlink{group__utils_gae0b9cd0ce090bd69b951aa73e8fa4f7d}{MIN2}(tmm + d5\_2, tmm\_2 + d3) : tmm + tmm\_2;
00702     \textcolor{keywordflow}{else}
00703       energy += d3 + d5\_2;
00704   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (p - i == 2) \{
00705     \textcolor{keywordflow}{if} (j - q > 2)
00706       energy += (ci && cp) ? \hyperlink{group__utils_gae0b9cd0ce090bd69b951aa73e8fa4f7d}{MIN2}(tmm + d3\_2, tmm\_2 + d5) : tmm + tmm\_2;
00707     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (j - q == 2)
00708       energy += \hyperlink{group__utils_gae0b9cd0ce090bd69b951aa73e8fa4f7d}{MIN2}(tmm, \hyperlink{group__utils_gae0b9cd0ce090bd69b951aa73e8fa4f7d}{MIN2}(tmm\_2, \hyperlink{group__utils_gae0b9cd0ce090bd69b951aa73e8fa4f7d}{MIN2}(d5 + d5\_2, d3 + d3\_2)));
00709     \textcolor{keywordflow}{else}
00710       energy += \hyperlink{group__utils_gae0b9cd0ce090bd69b951aa73e8fa4f7d}{MIN2}(d3, d5\_2);
00711   \} \textcolor{keywordflow}{else} \{
00712     \textcolor{keywordflow}{if} (j - q > 2)
00713       energy += d5 + d3\_2;
00714     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (j - q == 2)
00715       energy += \hyperlink{group__utils_gae0b9cd0ce090bd69b951aa73e8fa4f7d}{MIN2}(d5, d3\_2);
00716   \}
00717 
00718   \textcolor{keywordflow}{return} energy;
00719 \}
00720 
00721 
00726 \textcolor{preprocessor}{#endif}
00727 
00728 \textcolor{preprocessor}{#endif}
\end{DoxyCode}
